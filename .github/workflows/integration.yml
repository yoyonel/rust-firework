name: ğŸ§¨ Fireworks Integration Tests

on:
  # 1ï¸âƒ£ DÃ©clenche automatiquement aprÃ¨s le workflow CI
  workflow_run:
    workflows: [ "Rust CI with Coverage" ] # remplace par le nom exact de ton workflow de build
    types:
    - completed
  # 2ï¸âƒ£ DÃ©clenche manuellement depuis GitHub Actions
  workflow_dispatch:
  schedule:
  - cron: '0 0 * * *' # tous les jours Ã  minuit

jobs:
  integration-test:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout du code source
    - name: ğŸ›ï¸ Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Docker buildx (pour cache efficace)
    - name: ğŸ§± Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 4ï¸âƒ£ Build Docker image with inline cache ---
    - name: ğŸ”¨ Build Docker image (with cache)
      run: |
        docker build \
          --build-arg USER_ID=$(id -u) \
          --build-arg GROUP_ID=$(id -g) \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t fireworks-ci_integration \
          -f Dockerfile.ci .

    # 5ï¸âƒ£ ExÃ©cution du test dâ€™intÃ©gration
    - name: ğŸš€ Run integration test
      run: |
        mkdir -p output
        docker run --rm \
          -v ${{ github.workspace }}/output:/app/output \
          fireworks-ci_integration

    # 5ï¸âƒ£ Setup Python + cache UV (gestionnaire de dÃ©pendances)
    - name: ğŸ§© Setup Python environment
      run: |
        pip install uv

    - name: â™»ï¸ Cache UV dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    # 6ï¸âƒ£ Run Fireworks Analysis (post-processing)
    - name: ğŸ“Š Run Fireworks Analysis
      run: |
        echo "ğŸ“ˆ Running Fireworks post-analysis..."
        cd integration/visual_test
        uv run main.py ../../output/
      env:
        PYTHONUNBUFFERED: 1

    # 6ï¸âƒ£ Upload des artifacts de sortie (logs, screenshots, audioâ€¦)
    - name: ğŸ“¦ Upload output artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fireworks-output
        path: output/
        retention-days: 7

    # 8ï¸âƒ£ Publish HTML report to GitHub Pages
    - name: ğŸŒ Publish report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        publish_branch: gh-pages
