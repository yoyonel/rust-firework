name: üß® Fireworks Integration Tests

on:
  # 1Ô∏è‚É£ D√©clenche automatiquement apr√®s le workflow CI
  workflow_run:
    workflows: ["Rust CI with Coverage"]   # remplace par le nom exact de ton workflow de build
    types:
      - completed
  # 2Ô∏è‚É£ D√©clenche manuellement depuis GitHub Actions
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # tous les jours √† minuit

jobs:
  integration-test:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
  
    steps:
      # 1Ô∏è‚É£ Checkout du code source
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Docker buildx (pour cache efficace)
      - name: üß± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # # 3Ô∏è‚É£ Cache Docker layers (Cargo + apt cache)
      # - name: üíæ Cache Docker layers
      #   uses: actions/cache@v4
      #   with:
      #     path: /tmp/.buildx-cache
      #     key: ${{ runner.os }}-fireworks-ci-${{ github.sha }}
      #     restore-keys: |
      #       ${{ runner.os }}-fireworks-ci-

      # 4Ô∏è‚É£ Build Docker image with inline cache ---
      - name: üî® Build Docker image (with cache)
        run: |
          docker build \
            --build-arg USER_ID=$(id -u) \
            --build-arg GROUP_ID=$(id -g) \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t fireworks-ci_integration \
            -f Dockerfile.ci .

      # 5Ô∏è‚É£ Ex√©cution du test d‚Äôint√©gration
      - name: üöÄ Run integration test
        run: |
          mkdir -p output
          docker run --rm \
            -v ${{ github.workspace }}/output:/app/output \
            fireworks-ci_integration

      # 6Ô∏è‚É£ Upload des artifacts de sortie (logs, screenshots, audio‚Ä¶)
      - name: üì¶ Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fireworks-output
          path: output/
          retention-days: 7

      # # 7Ô∏è‚É£ Sauvegarde du cache Docker
      # - name: ‚ôªÔ∏è Save Docker cache
      #   if: always()
      #   run: |
      #     rm -rf /tmp/.buildx-cache
      #     mv /tmp/.buildx-cache-new /tmp/.buildx-cache