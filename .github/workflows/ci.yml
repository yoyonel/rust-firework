name: Rust CI with Coverage

on:
  push:           # sur chaque push
    branches:
      - main
      - develop
  pull_request:   # sur chaque pull request
    branches:
      - main
  workflow_dispatch:  # permet le lancement manuellement du workflow
  schedule:
    - cron: '0 0 * * *' # tous les jours à minuit

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      DISPLAY: :99

    steps:
      # --- Étape 1 : Checkout du code ---
      - uses: actions/checkout@v3

      # --- Étape 2 : Installer Rust ---
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.90.0
          target: x86_64-unknown-linux-gnu
          override: true
          components: rust-src

      # ⚡ Cache Cargo registry, index et target
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-      

      # --- Étape 3 : Installer les outils système ---
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake g++ \
            libgl1-mesa-dev libx11-dev libxcursor-dev libxi-dev \
            libxrandr-dev libxinerama-dev libglu1-mesa-dev \
            libasound2-dev alsa-utils alsa-oss \
            pulseaudio pulseaudio-utils \
            xvfb xauth pkg-config make git ca-certificates curl

      # ⚡ Cacher la toolchain et les composants LLVM
      - name: Cache Rust toolchain and LLVM tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/components
          key: ${{ runner.os }}-rustup-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            ${{ runner.os }}-rustup-
      
      # ⚡ Rust supporte un cache binaire plus puissant que Cargo : sccache
      # Il fonctionne comme ccache pour le compilateur Rust.
      - name: Install sccache
        run: cargo install sccache

      - name: Configure sccache
        run: |
          export RUSTC_WRAPPER=$(which sccache)
          sccache --start-server

      - name: Build with sccache
        run: cargo build --release

      # --- Étape 4 : Installer cargo-llvm-cov et LLVM tools ---
      - name: Install coverage tools
        run: |
          cargo install cargo-llvm-cov
          rustup component add llvm-tools-preview --toolchain 1.90.0-x86_64-unknown-linux-gnu

      # --- Étape 5 : Build du projet ---
      - name: Build project
        run: cargo build --release

      # --- Étape 6 : Lancer Xvfb pour les tests graphiques ---
      - name: Start virtual display
        run: |
          rm -f /tmp/.X99-lock
          Xvfb :99 -screen 0 1024x768x24 & 
          sleep 2

      # ⚡ Cacher les artefacts de coverage
      - name: Cache LLVM coverage data
        uses: actions/cache@v4
        with:
          path: target/llvm-cov
          key: ${{ runner.os }}-llvmcov-${{ hashFiles('Cargo.lock') }}

      # --- Étape 7 : Compiler tests instrumentés pour coverage ---
      - name: Prepare instrumented binaries
        run: cargo llvm-cov --workspace

      # --- Étape 8 : Lancer les tests avec coverage ---
      - name: Run tests with coverage
        run: cargo llvm-cov --workspace --tests -- --nocapture --test-threads=1
      
      # # --- Étape 9 : Publier le coverage (optionnel) ---
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: target/debug/coverage/*.profdata
      #     flags: unittests
