name: Rust CI with Coverage

on:
  push:           # sur chaque push
    branches:
      - main
      - develop
  pull_request:   # sur chaque pull request
    branches:
      - main
  workflow_dispatch:  # permet le lancement manuellement du workflow
  schedule:
    - cron: '0 0 * * *' # tous les jours √† minuit

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      DISPLAY: :99
      RUST_VERSION: 1.90.0
      RUSTC_WRAPPER: sccache
      CARGO_TERM_COLOR: always

    steps:
      # --- √âtape 1 : Checkout du code ---
      - uses: actions/checkout@v4

      # ü¶Ä 2. Installation de Rust toolchain
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: llvm-tools-preview

      # --- √âtape 3 : Installer les outils syst√®me ---
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake g++ \
            libgl1-mesa-dev libx11-dev libxcursor-dev libxi-dev \
            libxrandr-dev libxinerama-dev libglu1-mesa-dev \
            libasound2-dev alsa-utils alsa-oss \
            pulseaudio pulseaudio-utils \
            xvfb xauth pkg-config make git ca-certificates curl

      # üß∞ 3. Cache rustup + toolchain LLVM
      - name: Cache Rustup and LLVM tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/components
          key: ${{ runner.os }}-rustup-${{ env.RUST_VERSION }}
          restore-keys: |
            ${{ runner.os }}-rustup-
      
      # ‚ö° 4. Cache Cargo registry & git & bin (t√©l√©chargement d√©pendances)
      - name: Cache Cargo registry & git & bin
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      # üß± 5. Cache du r√©pertoire target (artefacts compil√©s)
      - name: Cache Cargo target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ env.RUST_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ env.RUST_VERSION }}-
            ${{ runner.os }}-cargo-target-
      
      # --- Installation ultra rapide de sccache (binaire pr√©compil√©) ---
      - name: Install sccache (binary)
        run: |
          SCCACHE_VERSION="0.7.4"
          curl -L "https://github.com/mozilla/sccache/releases/download/v${SCCACHE_VERSION}/sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o sccache.tar.gz
          tar xzf sccache.tar.gz
          sudo mv sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl/sccache /usr/local/bin/
          sccache --version
          echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV
      
      - name: SCCache start server
        run: sccache --start-server

       # üíæ 7. Cache sccache binaire (stocke les artefacts compil√©s)
      - name: Cache sccache binaries
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ env.RUST_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-${{ env.RUST_VERSION }}-
            ${{ runner.os }}-sccache-
      
      # --- √âtape 4 : Installer cargo-llvm-cov et LLVM tools ---
      - name: Install cargo-llvm-cov
        run: |
          if ! command -v cargo-llvm-cov &> /dev/null; then
            cargo install cargo-llvm-cov --locked
          else
            echo "cargo-llvm-cov already installed, skipping..."
          fi

      # --- √âtape 5 : Build du projet ---
      - name: Build project
        run: |
          cargo build --release

      # --- √âtape 6 : Lancer Xvfb pour les tests graphiques ---
      - name: Start virtual display
        run: |
          rm -f /tmp/.X99-lock
          Xvfb :99 -screen 0 1024x768x24 & 
          sleep 2
    
      # --- √âtape 8 : Lancer les tests avec coverage ---
      - name: Run tests with coverage
        run: |
          cargo llvm-cov --workspace --tests -- --nocapture --test-threads=1

      - name: SCCache stop server
        run: |
          sccache --show-stats
          sccache --stop-server

  integration-test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du code source
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Docker buildx (pour cache efficace)
      - name: üß± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3Ô∏è‚É£ Cache Docker layers (Cargo + apt cache)
      - name: üíæ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-fireworks-ci-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-fireworks-ci-

      # 4Ô∏è‚É£ Build de l‚Äôimage Docker CI
      - name: üî® Build Docker image (with cache)
        run: |
          docker build \
            --build-arg USER_ID=$(id -u) \
            --build-arg GROUP_ID=$(id -g) \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t fireworks-ci_integration \
            -f Dockerfile.ci .

      # 5Ô∏è‚É£ Ex√©cution du test d‚Äôint√©gration
      - name: üöÄ Run integration test
        run: |
          mkdir -p output
          docker run --rm \
            -v ${{ github.workspace }}/output:/app/output \
            fireworks-ci_integration

      # 6Ô∏è‚É£ Upload des artifacts de sortie (logs, screenshots, audio‚Ä¶)
      - name: üì¶ Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fireworks-output
          path: output/
          retention-days: 7

      # 7Ô∏è‚É£ Sauvegarde du cache Docker
      - name: ‚ôªÔ∏è Save Docker cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache